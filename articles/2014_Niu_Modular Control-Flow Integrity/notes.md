<!-- Please prefix the notes with the date as in [22/12/2020] -->

[05/10/2022]

Classic CFI enforcement determines the CFG then checks the direct branches targets. The indirect branches are delayed at runtime using **specific runtime checks**. An Equivalence-Check Number (ECN) that is a tag for possible branches from a function is attributed and checked before performing the control-flow transfer. At the target, the CFI inserts a way to obtain the **ECN** and the return instruction is rewritten to: 1 - pop the return address to a temporary register, 2 - retrieve the ECN, 3 - compare it to the return address and 4 - jump if equal, otherwise raise an exception. The need for uniqueness of ECN makes it impossible to support separate compilation of the different CFI modules as a single rewriting needs access to all modules.

MCFI enforces fine-grained CFI. It uses **ID tables**, similarly to classic CFI that partition indirect targets into equivalence classes and labels each with an ECN. To remove the uniqueness requirement, ECNs are stored in a **runtime data structure** that consists of **two separate tables**. The first one, the **branch ID table** or **bary**, maps from an indirect-branch location to the location's branch ID. The **target ID table** or **tary** maps from an address to the identifier of the equivalence class to which the address belongs. For an address `a` of a `ret` instruction, the corresponding ID is extracted from `bary[a]` and compared to the ID of the value of the return address `tary[ra]`. The table accesses can be concurrent and live side by side with  dynamic code installation. Indirect branch execution is 10^8 more frequent than code installation so a lock would slow down considerably. MCFI modules contain code, data and auxiliary information. MCFI adopts type information (functions and function pointers) used to generate a CFG.

MCFI's rewriter is implemented in LLVM adding three passes. MCFI's CFG generator is implemented in C++. MCFI's runtime is based on the MIP runtime. MCFI's linker is modified from `ld`.

##### tags: cfi, defense, security